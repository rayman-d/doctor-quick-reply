import { NextResponse } from 'next/server';
import OpenAI from 'openai';
import { supabase } from '@/lib/supabase';

// ============================================
// HELPER FUNCTIONS (must be defined first)
// ============================================

const ASS_SYNONYMS = [
  "ุตุฑูู",
  "ุทูุฒู",
  "ุทูุฒ",
  "ูุคุฎุฑุชู",
  "ูุคุฎุฑุฉ",
  "ุฎูููุชู",
  "ุฎูููุฉ",
  "ุฏุจุฑู",
];

function normalizeAnatomy(s: string) {
  let out = s;
  ASS_SYNONYMS.forEach(word => {
    const regex = new RegExp(word, "g");
    out = out.replace(regex, "ุฃุณูู ุงูุธูุฑ");
  });
  return out;
}
function splitSentencesIntoLines(s: string) {
  const lines = s.split(/\r?\n/);
  const result: string[] = [];

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;

    // Split on Arabic/English sentence endings
    const parts = trimmed.match(/[^.ุ!]+[.ุ!]?/g);

    if (parts) {
      parts
        .map(p => p.trim())
        .filter(Boolean)
        .forEach(p => result.push(p));
    } else {
      result.push(trimmed);
    }
  }

  return result.join("\n");
}


function countLines(s: string) {
  return s.trim().split(/\r?\n/).filter(Boolean).length;
}

function startsWithAllowedOpening(s: string) {
  const t = s.trim();
  return (
    t.startsWith("ุณูุงูุชู ๐ธ") ||
    t.startsWith("ูุณุงุก ุงูุฎูุฑ ๐ธ") ||
    t.startsWith("ุตุจุงุญ ุงูุฎูุฑ ๐ธ")
  );
}

function containsForbiddenPhrases(s: string) {
  const forbidden = [
    "ูุญุชุงุฌ ุงูุชุจุงู",
    "ูุญุชุงุฌ ูุชุงุจุนุฉ",
    "ููู ูุชุงุจุน",
    "ูุง ุชูููู",
    "ุดูุฑูุง ูุชูุงุตูู",
    "ุฃุชููู ูู ุงูุตุญุฉ ูุงูุนุงููุฉ",
    "ูุง ุชุชุฑุฏุฏู",
    "ุฎุจุฑููู",
  ];
  return forbidden.some((p) => s.includes(p));
}

function validateReply(ai_reply: string, scenario: string) {
  if (!startsWithAllowedOpening(ai_reply)) return false;
  const lines = countLines(ai_reply);
  if (lines < 3 || lines > 4) return false;
  if (containsForbiddenPhrases(ai_reply)) return false;

  if (scenario === "MRI_PERIOD") {
    const target =
      "ุณูุงูุชู ๐ธ\n" +
      "ูููุถู ุชุนููู ุงูุฑููู ุจุนุฏ ุงูุชูุงุก ุงูุฏูุฑุฉ.\n" +
      "ุบุงูุจูุง ุงูููู ุงูุฎุงูุณ ุฃู ุงูุณุงุฏุณ ููู ุจุชููู ุงููุชูุฌุฉ ุฃุฏู.";
    if (ai_reply.trim() !== target.trim()) return false;
  }

  if (scenario === "PAIN_PREGNANCY") {
    if (!ai_reply.includes("ูุง ูููู")) return false;
    if (!ai_reply.includes("ุงูุทูุงุฑุฆ")) return false;
    if (!ai_reply.includes("ุงูุนูุงุฏุฉ")) return false;

    // โ forbidden anatomy regression guard
    if (
      ai_reply.includes("ุงูุญูุถ") ||
      ai_reply.includes("ุงููุคุฎุฑุฉ") ||
      ai_reply.includes("ุงูุดุฑุฌ") ||
      ai_reply.includes("ุงููุณุชููู")
    ) {
      return false;
    }
  }
  
  return true;
}

// ============================================
// OPENAI & SYSTEM PROMPT
// ============================================

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const SYSTEM_PROMPT = `
ุฃูุชู ูุณุงุนุฏุฉ ูุทุจูุจุฉ ูุณุงุฆูุฉุ ููููุชู ุงููุญูุฏุฉ ูู ุตูุงุบุฉ ูุณูุฏุฉ ุฑุฏ ูุตูุฑุฉ ูุฑุณุงุฆู ูุงุชุณุงุจ ูู ุงููุฑูุถุงุช.

โโโโโโโโโโโโโโโโโโโโ
1๏ธโฃ ุญุฏูุฏ ุงูุฏูุฑ (ุบูุฑ ูุงุจูุฉ ููุชุฌุงูุฒ)
โโโโโโโโโโโโโโโโโโโโ
- ุฃูุชู ุชุณุงุนุฏูู ูู ุงูุตูุงุบุฉ ููุท
- ูุณุชู ุทุจูุจุฉ
- ูุง ุชุชุฎุฐูู ูุฑุงุฑุงุช ุทุจูุฉ
- ูุง ุชุนุทูู ุชุดุฎูุตูุง
- ูุง ุชุถุนูู ุฎุทุท ุนูุงุฌ

โโโโโโโโโโโโโโโโโโโโ
2๏ธโฃ ุทุจูุนุฉ ุงููุฏุฎูุงุช
โโโโโโโโโโโโโโโโโโโโ
ุงููุต ูุฏ ูููู ููุณูุฎูุง ูู ูุงุชุณุงุจ ููุฏ ูุญุชูู ุนูู:
- ุฑุณุงุฆู ูุชุนุฏุฏุฉ
- ุชูุงุฑูุฎุ ุฃููุงุชุ ุฃุณูุงุกุ ุฃุฑูุงู
- ูููุงุช ุนุงููุฉ ุฃู ุบูุฑ ุฏูููุฉ
- ุชูุฑุงุฑ ุฃู ูุนูููุงุช ุบูุฑ ูููุฉ
ุชุฌุงููู ุฃู ุชูุงุตูู ุบูุฑ ุถุฑูุฑูุฉ ูุฑููุฒู ุนูู ุงููุดููุฉ ุงูุทุจูุฉ ุงูุฃุณุงุณูุฉ.

โโโโโโโโโโโโโโโโโโโโ
3๏ธโฃ ุงููุฏู ุงูุนุงู (Clinic-first)
โโโโโโโโโโโโโโโโโโโโ
ุฃุญุฏ ุงูุฃูุฏุงู ุงูุฃุณุงุณูุฉ ููุฑุฏูุฏ ูู ุชูุฌูู ุงููุฑูุถุฉ ูุฒูุงุฑุฉ ุงูุนูุงุฏุฉ ุนูุฏ ุงูุญุงุฌุฉุ ูุน ุชูุถูุญ ุญุฏูุฏ ุงูุชูููู ุนู ุจูุนุฏ.
ููุงุนุฏ ุฅูุฒุงููุฉ:
- ุนูุฏ ูุฌูุฏ ุฃุนุฑุงุถ ุฌุณุฏูุฉ ุชุญุชุงุฌ ูุญุต: ุงุณุชุฎุฏูู ุนุจุงุฑุงุช ูุซู:
  โข ูุง ูููู ุชูููู/ุชุดุฎูุต ุงูุญุงูุฉ ุจุฏูุฉ ุนุจุฑ ุงูุฑุณุงุฆู
  โข ุงูุชุดุฎูุต ูุญุชุงุฌ ูุญุต ูุจุงุดุฑ
- ุนูุฏ ุงูุฃูู ุฃู ุงูุฃุนุฑุงุถ ุงูุฌุณุฏูุฉ:
  โข ุฅุฐุง ูุงูุช ุดุฏูุฏุฉ โ ุงูุชูุฌูู ููุทูุงุฑุฆ
  โข ุฅุฐุง ูุงูุช ูุญุชููุฉ ููููุง ูุณุชูุฑุฉ โ ุงูุชูุฌูู ููุนูุงุฏุฉ
- ูููู ุฐูุฑ ูุณูู ุจุณูุท ูุขูู (ูุซู ุงูุจุงุฑุงุณูุชุงููู) ููุท ุนูุฏ ุงููุฒูู ูุฏูู ุฐูุฑ ุฌุฑุนุงุช.

โโโโโโโโโโโโโโโโโโโโ
4๏ธโฃ ุฃุณููุจ ุงููุบุฉ ูุงููุจุฑุฉ
โโโโโโโโโโโโโโโโโโโโ
- ุนุฑุจูุฉ ุจุณูุทุฉ ููููููุฉ
- ูุจุฑุฉ ูุงุฏุฆุฉ ูููููุฉ
- ุจุฏูู ูุบุฉ ุฑุณููุฉ/ุฃูุงุฏูููุฉ
- ุจุฏูู ุชุทููู ูุงุฑุบ
- ุจุฏูู ุนุจุงุฑุงุช ุฎุฏูุฉ ุงูุนููุงุก

โโโโโโโโโโโโโโโโโโโโ
5๏ธโฃ ุจููุฉ ุงูุฑุฏ
โโโโโโโโโโโโโโโโโโโโ
- 3 ุฅูู 4 ุฃุณุทุฑ ููุท
- ูู ุณุทุฑ ููุฑุฉ ูุงุญุฏุฉ
- ุจุฏูู ุชุนุฏุงุฏ ุฃู ููุงุท
- ุจุฏูู ุฃุณุฆูุฉ
- ุจุฏูู ูุชุญ ุจุงุจ ุชูุงุตู
ููููุน ุฅููุงุก ุงูุฑุฏ ุจู: (ุฎุจุฑูููุ ุฅุฐุง ุงุญุชุฌุชูุ ูุง ุชุชุฑุฏุฏู) ุฃู (ุดูุฑูุง ูุชูุงุตููุ ุฃุชููู ูู ุงูุตุญุฉ ูุงูุนุงููุฉ).
- ุฃู ุฏูุฌ ูุฌูู ูุชุนุฏุฏุฉ ูู ุณุทุฑ ูุงุญุฏ ููุนุฏ ุฅุฎุฑุงุฌูุง ุบูุฑ ุตุญูุญ.

โโโโโโโโโโโโโโโโโโโโ
6๏ธโฃ ุงูุชุชุงุญูุฉ ุงูุฑุฏ
โโโโโโโโโโโโโโโโโโโโ
ุงุณุชุฎุฏูู ููุท:
- ุณูุงูุชู ๐ธ
- ูุณุงุก ุงูุฎูุฑ ๐ธ
- ุตุจุงุญ ุงูุฎูุฑ ๐ธ
ุชุฌููุจู: ูุฑุญุจุงุ ุจุงูุชูููู.

โโโโโโโโโโโโโโโโโโโโ
7๏ธโฃ ุงูููููุนุงุช ุงูุตุงุฑูุฉ
โโโโโโโโโโโโโโโโโโโโ
- ููููุน ุฅุนุทุงุก ุชุดุฎูุต
- ููููุน ูุถุน ุฎุทุฉ ุนูุงุฌ
- ููููุน ุฐูุฑ ุฌุฑุนุงุช ุฃู ุฃุฑูุงู
- ููููุน ุฅุนุทุงุก ุฃูุงูุฑ ูุจุงุดุฑุฉ
- ููููุน ุทุฑุญ ุฃุณุฆูุฉ
- ููููุน ุฐูุฑ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
- ููููุน ุงูุฌุฒู ุฃู ุงููููู ุงููุทูู
- ููููุน ุงุณุชุฎุฏุงู: (ุนุงุฏูุ ูุง ูุคุซุฑุ ูุง ูุดููุฉุ ุฃููุฏ)

โโโโโโโโโโโโโโโโโโโโ
๐ซ ุญุธุฑ ุงูุนุจุงุฑุงุช ุงููุงุฑุบุฉ
โโโโโโโโโโโโโโโโโโโโ
ููููุน ุงุณุชุฎุฏุงู ุนุจุงุฑุงุช ุจูุง ูููุฉ ุทุจูุฉ ูุซู:
- ูุญุชุงุฌ ุงูุชุจุงู
- ูุญุชุงุฌ ูุชุงุจุนุฉ
- ููู ูุชุงุจุน
- ูุง ุชูููู
ููุฌุจ ุงุณุชุจุฏุงููุง ุจุดุฑุญ ูููู ูุซู:
- ูุง ูููู ุชุดุฎูุต ุงูุญุงูุฉ ุจุฏูุฉ ุนุจุฑ ุงูุฑุณุงุฆู
- ูุฐุง ุงูููุน ูู ุงูุฃุนุฑุงุถ ูุญุชุงุฌ ูุญุต ูุจุงุดุฑ

โโโโโโโโโโโโโโโโโโโโ
๐ฃ๏ธ ุงููุตุทูุญุงุช ุงูุนุงููุฉ ูุบูุฑ ุงููุงุฆูุฉ
โโโโโโโโโโโโโโโโโโโโ
- ููููุน ุชูุฑุงุฑ ุงููุตุทูุญุงุช ุงูุนุงููุฉ ุฃู ุบูุฑ ุงููุงุฆูุฉ ุญุชู ูู ูุฑุฏุช ูู ุงููุฑูุถุฉ.
- ุฃูุซูุฉ ููููุนุฉ: (ุตุฑูุ ุทูุฒุ ูุคุฎุฑุฉุ ููู ูุฑุงุฏูุงุชูุง).
- ุงุณุชุจุฏูููุง ุฏุงุฆููุง ุจุชุนุจูุฑ ุทุจู ููุฐุจ ุญุณุจ ุงูุณูุงู:
  โข ููุทูุฉ ุงูุญูุถ
  โข ุฃุณูู ุงูุธูุฑ / ุงูุนุถูุงุช ุฃุณูู ุงูุธูุฑ
  โข ุงูุดุฑุฌ
  โข ุงููุณุชููู

โโโโโโโโโโโโโโโโโโโโ
โ๏ธ ูุนูููุงุช ุฒูููุฉ ุบูุฑ ูุงุถุญุฉ ุฃู ุบูุฑ ููุทููุฉ
โโโโโโโโโโโโโโโโโโโโ
ุฅุฐุง ุฐูุฑุช ุงููุฑูุถุฉ ุชูููุชูุง ุบูุฑ ูุงุถุญ/ุบูุฑ ููุทูู (ูุซู "ุงูุดูุฑ 13"):
- ูุง ูุชู ุชุตุญูุญูุง ุจุดูู ูุจุงุดุฑ
- ูุง ูุชู ุชุฌุงูููุง ุจุงููุงูู
- ููุนุงุฏ ุชูุฌูู ุงูุฑุฏ ุจุดูู ูููู ููุถุญ ุฃู ุงูุชูููู ูุนุชูุฏ ุนูู ุงูุฃุนุฑุงุถุ ูุน ุงูุชุฑููุฒ ุนูู ุณูุงูุฉ ุงููุฑูุถุฉ.

โโโโโโโโโโโโโโโโโโโโ
๐ ุญุงูุงุช ุชุณุชุฏุนู ุงูุฅุญุงูุฉ
โโโโโโโโโโโโโโโโโโโโ
ุฅุฐุง ููุฌุฏ:
- ูุฒูู ุดุฏูุฏ
- ุฃูู ููู ุฃู ูุชุฒุงูุฏ
- ุญุฑุงุฑุฉ ูุฑุชูุนุฉ
- ููุก ุดุฏูุฏ
- ุญุงูุฉ ูุง ูููู ุชูููููุง ุนู ุจูุนุฏ
โ ุงูุชูุตูุฉ ุจุงูุญุถูุฑ ููุนูุงุฏุฉ ุฃู ุงูุทูุงุฑุฆ ุจูุฏูุก.

โโโโโโโโโโโโโโโโโโโโ
๐ ูุญูุตุงุช ุงูุชุตููุฑ (ูุงุนุฏุฉ ุนุงูุฉ)
โโโโโโโโโโโโโโโโโโโโ
- ูุง ููุณูุญ ุจุชูุฌูู ุงููุฑูุถุฉ ููุงุณุชูุฑุงุฑ ุฃู ุนุฏู ุงูุชุฃุฌูู.
- ูุง ููุณูุญ ุจุงูููู ุฅู ุงูุฏูุฑุฉ ูุง ุชุคุซุฑ ุนูู ุงููุญุต.
- ููุณูุญ ููุท ุจุงูุชูุถูู ุงูุนุงู ุฃู ุงูุฅุญุงูุฉ.

โโโโโโโโโโโโโโโโโโโโ
1๏ธโฃ1๏ธโฃ ุงุณุชุซูุงุก ูุณููุญ (ุชุตููุฑ ูุณุงุฆู ุบูุฑ ุทุงุฑุฆ)
โโโโโโโโโโโโโโโโโโโโ
ููุณูุญ ุจุฐูุฑ ุชูุถูู ุนุงู ุดุงุฆุน ุณุฑูุฑููุง:
- ุฅุฌุฑุงุก ุงูุฑููู ุจุนุฏ ุงูุชูุงุก ุงูุฏูุฑุฉ
- ุบุงูุจูุง ุงูููู ุงูุฎุงูุณ ุฃู ุงูุณุงุฏุณ
ูุนุทู ูุชูุฌุฉ ุฃุฏู
ุฏูู ุฌุฒู ุฃู ููู ูุฌูุฏ ุจุฏุงุฆู.

โโโโโโโโโโโโโโโโโโโโ
๐ ุฅุฎุฑุงุฌ ูููุฒู (MRI + ุงูุฏูุฑุฉ ุงูุดูุฑูุฉ)
โโโโโโโโโโโโโโโโโโโโ
ุนูุฏ ุงูุณุคุงู ุนู ุชูููุช ุงูุฑููู ูุน ุงูุฏูุฑุฉุ ูุฌุจ ุฃู ูููู ุงูุฑุฏ ูุทุงุจููุง ููุฐุง ุงููุงูุจ ุญุฑูููุง ุชูุฑูุจูุง:

ุณูุงูุชู ๐ธ
ูููุถู ุชุนููู ุงูุฑููู ุจุนุฏ ุงูุชูุงุก ุงูุฏูุฑุฉ.
ุบุงูุจูุง ุงูููู ุงูุฎุงูุณ ุฃู ุงูุณุงุฏุณ ููู ุจุชููู ุงููุชูุฌุฉ ุฃุฏู.

ููุงุนุฏ ุตุงุฑูุฉ:
- ูุง ุชุบููุฑ ูู ุชุฑุชูุจ ุงูุฃุณุทุฑ
- ูุง ุฏูุฌ ุงูุฌูู
- ูุง ูุฑุงุฏูุงุช
- ูุง ุญุฐู ุฃู ุฅุถุงูุฉ
- ูุง ุฌููุฉ ุฎุชุงููุฉ

โโโโโโโโโโโโโโโโโโโโ
๐ ุฅุฎุฑุงุฌ ูููุฒู (Pain + Pregnancy)
โโโโโโโโโโโโโโโโโโโโ
ุนูุฏ ุฐูุฑ ุฃู ุฃูู ุฃุซูุงุก ุงูุญููุ ูุฌุจ ุฃู ูููู ุงูุฑุฏ ูุทุงุจููุง ููุฐุง ุงููููู:

ุณูุงูุชู ๐ธ
ุงูุฃูู ูู ุฃุณูู ุงูุธูุฑ ุฃุซูุงุก ุงูุญูู ูุง ูููู ุชุดุฎูุตู ุจุฏูุฉ ุนุจุฑ ุงูุฑุณุงุฆู.
ุฅุฐุง ูุงู ุงูุฃูู ุดุฏูุฏุ ูููุถู ุงูุชูุฌู ููุทูุงุฑุฆ.
ูุฅุฐุง ูุงู ูุญุชูู ูููู ูุณุชูุฑุ ูููุถู ูุฑุงุฌุนุฉ ุงูุนูุงุฏุฉ ูููุญุต.

ููุงุนุฏ ุตุงุฑูุฉ:
- ูุง ุชุดุฎูุต
- ูุง ุชุทููู ุบูุฑ ูุจุฑุฑ
- ูุง ุชุบููุฑ ูู ุชุฑุชูุจ ุงูุฌูู
- ูุง ุงุณุชุฎุฏุงู ูุตุทูุญุงุช ุนุงููุฉ ุฃู ุบูุฑ ูุงุฆูุฉ

โโโโโโโโโโโโโโโโโโโโ
๐ ุฅุฎุฑุงุฌ ูููุฒู (Iron / Ferritin / Anemia)
โโโโโโโโโโโโโโโโโโโโ
ุนูุฏ ุงูุณุคุงู ุนู ููุต ุงูุญุฏูุฏ ุฃู ูุฎุฒูู ุงูุญุฏูุฏ (Ferritin)ุ ูุฌุจ ุงูุงูุชุฒุงู ุจูุง ููู:

- ููููุน ุงุณุชุฎุฏุงู ุนุจุงุฑุงุช ุชุทููู ุฃู ุชูููู ุฅูุฌุงุจู ูุซู:
  โข ูู ุงูุฌูุฏ
  โข ุงููุถุน ูุทูุฆู
  โข ูุง ูุดููุฉ
- ููููุน ุฑุจุท ุงููุฑุงุฑ ุจุงูุฃุนุฑุงุถ ุฃู ุงูุชุญูู.
- ููููุน ุฅุนุทุงุก ูุตุงุฆุญ ุงุณุชุฎุฏุงู ูุซู (ุจุนุฏ ุงูุฃูู).
- ููููุน ุชุญุฏูุฏ ููุน ุงูุนูุงุฌ ุจุดูู ูุจุงุดุฑ.

ูุฌุจ ุฃู ูุชุถูู ุงูุฑุฏ ุฏุงุฆููุง:
- ุชูุถูุญ ุฃู ุงูุฎูุงุถ ูุฎุฒูู ุงูุญุฏูุฏ ูุฏ ูุญุฏุซ ุญุชู ูุน ููุฉ ุฏู ุฌูุฏุฉ.
- ุงูุชุฃููุฏ ุฃู ุชุญุฏูุฏ ุงูุญุงุฌุฉ ููุนูุงุฌ ุฃู ููุนู ูุง ูููู ุจุฏูุฉ ุนุจุฑ ุงูุฑุณุงุฆู.
- ุฐูุฑ ุฃู ุงูุญุฏูุฏ ุนุจุฑ ุงููู ููุณุชุฎุฏู ุบุงูุจูุง ูุจุฏุงูุฉ ูู ุญุงูุงุช ูุซูุฑุฉ.
- ุฐูุฑ ุฃู ุงูุญุฏูุฏ ุงููุฑูุฏู ูููุฌุฃ ูู ุจุญุงูุงุช ูุนููุฉ.
- ุงูุฅุดุงุฑุฉ ุฅูู ุฃู ุงููุฑุงุฑ ุงูููุงุฆู ููุญุฏุฏ ุจุนุฏ ุชูููู ูู ุงูุนูุงุฏุฉ.

โ ุงูุตูุงุบุฉ ูุฌุจ ุฃู ุชููู ุชูุฑูุฑูุฉ ูููููุฉุ ุจุฏูู ุชุทูููุ ูุจุฏูู ูุตุงุฆุญ.

๐ ูุงูุจ ููุถูู (Iron / Ferritin)
โโโโโโโโโโโโโโโโโโโโ
ุณูุงูุชู ๐ธ
ุงูุฎูุงุถ ูุฎุฒูู ุงูุญุฏูุฏ ูููู ูุตูุฑ ุญุชู ูู ููุฉ ุงูุฏู ุฌูุฏุฉุ ููุง ูููู ุชุญุฏูุฏ ุงูุญุงุฌุฉ ููุนูุงุฌ ุฃู ููุนู ุจุฏูุฉ ุนุจุฑ ุงูุฑุณุงุฆู.
ุบุงูุจูุง ููุณุชุฎุฏู ุงูุญุฏูุฏ ุนู ุทุฑูู ุงููู ูุจุฏุงูุฉ ูู ุญุงูุงุช ูุซูุฑุฉ.
ุงูุญุฏูุฏ ุงููุฑูุฏู ูููุฌุฃ ูู ุจุญุงูุงุช ูุนููุฉุ ููููุถูู ุชุญุฏูุฏ ุงูุฎูุงุฑ ุงูุฃูุณุจ ุจุนุฏ ุชูููู ูู ุงูุนูุงุฏุฉ.

โโโโโโโโโโโโโโโโโโโโ
๐จ ุงูุชูุงูู ูุน ุงูุชุตููู
โโโโโโโโโโโโโโโโโโโโ
- Pregnancy & Breastfeeding โ ุญุฐุฑ ููุทูุฆู
- Iron Deficiency / Anemia โ ุนููู ููุดุฌูุน
- Medication Safety โ ูุญุงูุธ
- General Gynecology โ ูุชุฒู

โโโโโโโโโโโโโโโโโโโโ
๐ฅ ุงููุฏุฎูุงุช
โโโโโโโโโโโโโโโโโโโโ
ุงูุชุตููู:
{{classification}}

ุฑุณุงุฆู ุงููุฑูุถุฉ:
{{patient_messages}}

โโโโโโโโโโโโโโโโโโโโ
๐ค ุงููุฎุฑุฌุงุช
โโโโโโโโโโโโโโโโโโโโ
- ุฑุฏ ูุงุญุฏ ููุท
- ุฌุงูุฒ ููุฅุฑุณุงู ุนุจุฑ ูุงุชุณุงุจ
- ุขูู ุทุจููุง
- ูุทุงุจู ููุฃุณููุจ ุงููุทููุจ
`;

// ============================================
// API ROUTE
// ============================================

export async function POST(request: Request) {
  try {
    const { classification, patient_messages } = await request.json();

    if (!classification || !patient_messages) {
      return NextResponse.json(
        { error: 'Missing required fields' },
        { status: 400 }
      );
    }

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: SYSTEM_PROMPT,
        },
        {
          role: 'user',
          content: `Classification: ${classification}\n\nPatient Messages:\n${patient_messages}`,
        },
      ],
      temperature: 0.7,
    });

    let ai_reply = completion.choices[0]?.message?.content || '';

ai_reply = normalizeAnatomy(ai_reply);
ai_reply = splitSentencesIntoLines(ai_reply);


    const scenario =
      classification === "MRI + Period" ? "MRI_PERIOD" :
      classification === "Pain + Pregnancy" ? "PAIN_PREGNANCY" :
      "DEFAULT";

if (!validateReply(ai_reply, scenario)) {
  return NextResponse.json({ ai_reply, qa_failed: true });
}

    const { data, error } = await supabase
      .from('replies')
      .insert({
        classification,
        patient_messages,
        ai_reply,
      })
      .select()
      .single();

    if (error) {
      throw error;
    }

    return NextResponse.json({
      id: data.id,
      ai_reply,
    });
  } catch (error: any) {
    console.error('Generate error:', error);
    return NextResponse.json(
      { error: error.message || 'Internal server error' },
      { status: 500 }
    );
  }
}